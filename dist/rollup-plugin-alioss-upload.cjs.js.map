{"version":3,"file":"rollup-plugin-alioss-upload.cjs.js","sources":["../src/index.js"],"sourcesContent":["import oss from \"ali-oss\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport { promisify } from \"util\";\nimport co from \"co\";\n\nconst readFile = promisify(fs.readFile);\nconst readDir = promisify(fs.readdir);\nlet store = null;\nlet config = {};\nlet prefixPath = \"/\";\nlet uploadIndex = 0;\n\nasync function upload(configFile, bundle) {\n\tif (configFile === undefined)\n\t\treturn;\n\ttry\n\t{\n    config = await readFile(configFile, \"utf-8\").then(data => JSON.parse(data));\n    store = oss(config);\n\n\t\tawait uploadFile(path.basename(bundle.file), bundle.bundle.code).then(\n      result => {\n        if (uploadIndex++ === 0) {\n          console.log(\"\\n\\n OSS 上传中......\");\n        }\n        console.log(`上传成功: ${bundle.file}`);\n        // Promise.resolve('上传成功')\n      }\n    ).catch(err => {\n      console.log(\"\\n\");\n      console.log(\n        `OSS 上传出错:::: ${err.name}-${err.code}: ${err.message}`\n      );\n    });\n\t}\n\tcatch(err)\n\t{\n\t\tconsole.log(`alioss-upload: failed -- ${err.stack}`, configFile);\n\t}\n}\n\nfunction uploadFile (name, source) {\n  let retryTimes = 2;\n  const uploadStore = () => {\n    return co(function*() {\n      const uploadName = `${prefixPath}${name}`;\n      return yield store.put(uploadName, Buffer.from(source));\n    }).catch(e => {\n      if (retryTimes <= 0) {\n        return Promise.reject(e);\n      }\n      retryTimes--;\n      return uploadStore();\n    });\n  };\n  return uploadStore();\n}\n\nexport default function aliossUpload({ configFile=\".alioss.config.json\", prefix=\"/\" }) {\n\treturn {\n\t\tname: \"alioss-upload\",\n\n\t\tonwrite(bundle) {\n      prefixPath = prefix.endsWith(\"/\") ? prefix : `${prefix}/`;\n\t\t\tPromise.resolve(upload(configFile, bundle));\n\t\t}\n\t};\n}\n"],"names":["readFile","promisify","fs.readFile","fs.readdir","path.basename"],"mappings":";;;;;;;;;;;AAMA,MAAMA,UAAQ,GAAGC,cAAS,CAACC,WAAW,CAAC,CAAC;AACxC,MAAM,OAAO,GAAGD,cAAS,CAACE,UAAU,CAAC,CAAC;AACtC,IAAI,KAAK,GAAG,IAAI,CAAC;AACjB,IAAI,MAAM,GAAG,EAAE,CAAC;AAChB,IAAI,UAAU,GAAG,GAAG,CAAC;AACrB,IAAI,WAAW,GAAG,CAAC,CAAC;;AAEpB,eAAe,MAAM,CAAC,UAAU,EAAE,MAAM,EAAE;CACzC,IAAI,UAAU,KAAK,SAAS;EAC3B,OAAO;CACR;CACA;IACG,MAAM,GAAG,MAAMH,UAAQ,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;IAC5E,KAAK,GAAG,GAAG,CAAC,MAAM,CAAC,CAAC;;EAEtB,MAAM,UAAU,CAACI,aAAa,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,IAAI;MACjE,MAAM,IAAI;QACR,IAAI,WAAW,EAAE,KAAK,CAAC,EAAE;UACvB,OAAO,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;SACnC;QACD,OAAO,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;;OAErC;KACF,CAAC,KAAK,CAAC,GAAG,IAAI;MACb,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;MAClB,OAAO,CAAC,GAAG;QACT,CAAC,aAAa,EAAE,GAAG,CAAC,IAAI,CAAC,CAAC,EAAE,GAAG,CAAC,IAAI,CAAC,EAAE,EAAE,GAAG,CAAC,OAAO,CAAC,CAAC;OACvD,CAAC;KACH,CAAC,CAAC;EACL;CACD,MAAM,GAAG;CACT;EACC,OAAO,CAAC,GAAG,CAAC,CAAC,yBAAyB,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE,UAAU,CAAC,CAAC;EACjE;CACD;;AAED,SAAS,UAAU,EAAE,IAAI,EAAE,MAAM,EAAE;EACjC,IAAI,UAAU,GAAG,CAAC,CAAC;EACnB,MAAM,WAAW,GAAG,MAAM;IACxB,OAAO,EAAE,CAAC,YAAY;MACpB,MAAM,UAAU,GAAG,CAAC,EAAE,UAAU,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC;MAC1C,OAAO,MAAM,KAAK,CAAC,GAAG,CAAC,UAAU,EAAE,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;KACzD,CAAC,CAAC,KAAK,CAAC,CAAC,IAAI;MACZ,IAAI,UAAU,IAAI,CAAC,EAAE;QACnB,OAAO,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;OAC1B;MACD,UAAU,EAAE,CAAC;MACb,OAAO,WAAW,EAAE,CAAC;KACtB,CAAC,CAAC;GACJ,CAAC;EACF,OAAO,WAAW,EAAE,CAAC;CACtB;;AAED,AAAe,SAAS,YAAY,CAAC,EAAE,UAAU,CAAC,qBAAqB,EAAE,MAAM,CAAC,GAAG,EAAE,EAAE;CACtF,OAAO;EACN,IAAI,EAAE,eAAe;;EAErB,OAAO,CAAC,MAAM,EAAE;MACZ,UAAU,GAAG,MAAM,CAAC,QAAQ,CAAC,GAAG,CAAC,GAAG,MAAM,GAAG,CAAC,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC;GAC7D,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC,CAAC;GAC5C;EACD,CAAC;CACF;;;;"}